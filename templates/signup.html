<!-- templates/signup.html -->
{% extends "base.html" %}

{% block title %}Sign Up - AyudaBesh{% endblock %}

{% block extra_css %}
<style>
    body { 
        font-family: Arial, sans-serif; 
        max-width: 500px; 
        margin: 50px auto; 
        padding: 20px; 
    }
    input, select { 
        width: 100%; 
        padding: 8px; 
        margin: 8px 0; 
        box-sizing: border-box; 
    }
    button { 
        background: #0070f3; 
        color: white; 
        padding: 10px; 
        border: none; 
        cursor: pointer; 
        width: 100%;
    }
    button:hover { 
        background: #0055bb; 
    }
    .error { 
        color: red; 
        margin-top: 10px; 
    }
    .success { 
        color: green; 
        margin-top: 10px; 
    }
</style>
{% endblock %}

{% block content %}
<h1>Create an Account</h1>
<form id="signupForm">
    <input type="text" id="username" name="username" placeholder="Username" required>
    <input type="text" id="fullname" name="fullName" placeholder="Full Name" required>
    <input type="email" id="email" name="email" placeholder="Email" required>
    <input type="password" id="password" name="password" placeholder="Password" required>
    
    <!-- ✅ Mandatory role selection -->
    <select id="role" name="role" required>
        <option value="">Select Your Role</option>
        <option value="customer">Customer</option>
        <option value="provider">Provider</option>
    </select>
    
    <button type="submit">Sign Up</button>
</form>

<div id="message"></div>

<p>Already have an account? <a href="/login">Log in</a></p>

<script>
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Validate role selection
        if (!data.role || data.role === "") {
            document.getElementById('message').innerHTML = 
                `<p class="error">Please select a role</p>`;
            return;
        }

        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            const messageDiv = document.getElementById('message');

            if (response.ok) {
                messageDiv.innerHTML = `<p class="success">Account created! Redirecting...</p>`;
                setTimeout(() => {
                    // ✅ Redirect based on selected role
                    const redirectUrl = data.role === 'customer' 
                        ? '/customer/dashboard' 
                        : '/provider/dashboard';
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                messageDiv.innerHTML = `<p class="error">${result.error || 'Signup failed'}</p>`;
            }
        } catch (error) {
            document.getElementById('message').innerHTML = 
                `<p class="error">Network error: ${error.message}</p>`;
            console.error('Signup error:', error);
        }
    });
</script>
{% endblock %}